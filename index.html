<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pakistan Salary Tax Calculator (FY 2025–26 / TY 2026)</title>

  <!-- jsPDF for PDF download (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --blue:#0a66c2;
      --blue2:#0b5cad;
      --soft:#f1f5f9;
      --soft2:#eef2ff;
      --good:#16a34a;
      --warn:#f59e0b;
      --shadow: 0 10px 30px rgba(2, 6, 23, 0.08);
      --radius:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:22px;
    }

    .container{max-width:1040px;margin:0 auto}

    .header{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .title{
      font-size:28px; font-weight:800; letter-spacing:-0.02em; margin:0;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      background:var(--soft2);
      border:1px solid #dbeafe;
      color:#1e40af;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      height: fit-content;
    }

    .subnote{
      margin:0 0 18px 0;
      color:var(--muted);
      line-height:1.5;
      font-size:13px;
    }
    .subnote b{color:var(--text)}

    .grid{ display:grid; gap:14px; }

    /* Mobile: 1 col, Tablet: 2 col, Desktop: 3 col */
    .grid.form{ grid-template-columns: 1fr; }
    @media(min-width:720px){ .grid.form{ grid-template-columns: 1fr 1fr; } }
    @media(min-width:980px){ .grid.form{ grid-template-columns: 1.1fr 1fr 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
    }
    .card .inner{ padding:16px; }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:0.02em;
      color:#0b1220;
      text-transform: none;
    }

    .field label{
      display:block;
      font-size:12px;
      color:#0b1220;
      font-weight:700;
      margin-bottom:6px;
    }
    .hint{font-size:12px;color:var(--muted);margin-top:6px}

    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
      outline:none;
    }
    input:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 4px rgba(59,130,246,0.12);
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      border:none;
      border-radius:12px;
      padding:12px 14px;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      transition:0.15s ease;
      width:100%;
    }
    .btn.primary{ background:var(--blue); color:#fff; }
    .btn.primary:hover{ background:var(--blue2); }
    .btn.secondary{
      background:#ffffff;
      color:#0b1220;
      border:1px solid var(--border);
    }
    .btn.secondary:hover{ background:#f8fafc; }

    @media(min-width:720px){
      .btn{ width:auto; }
      .btn.primary{ min-width:220px; }
    }

    .kpis{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:8px;
    }
    @media(min-width:720px){
      .kpis{ grid-template-columns: 1fr 1fr; }
    }

    .kpi{
      background:var(--soft);
      border:1px solid #e2e8f0;
      border-radius:12px;
      padding:12px;
    }
    .kpi .label{font-size:12px;color:var(--muted);font-weight:700;margin-bottom:6px}
    .kpi .value{font-size:18px;font-weight:900;letter-spacing:-0.02em}

    .row{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap;
      padding:10px 0;
      border-bottom:1px dashed #e2e8f0;
    }
    .row:last-child{border-bottom:none}
    .row .left{color:var(--muted);font-size:13px;font-weight:700}
    .row .right{font-size:13px;font-weight:800}

    .pill{
      display:inline-flex; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid var(--border);
      background:#fff;
      color:#0b1220;
    }
    .pill.good{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .pill.warn{ background:#fffbeb; border-color:#fde68a; color:#92400e; }

    /* Tables */
    .tableWrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:760px; /* slightly wider because we added a new column */
    }
    th, td{
      padding:10px 12px;
      border-bottom:1px solid #eef2f7;
      text-align:left;
      font-size:13px;
      white-space:nowrap;
    }
    th{
      background:#f8fafc;
      font-size:12px;
      color:#0b1220;
      position:sticky;
      top:0;
      z-index:1;
    }
    .trApplied{ background:#eef2ff; }
    .rightAlign{ text-align:right; }

    .footerNote{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media(min-width:980px){
      .twoCol{ grid-template-columns: 1fr 1fr; }
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#0b1220;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
    }
    .toast.show{ opacity:1; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1 class="title">Pakistan Salary Tax Calculator</h1>
      <div class="badge">FY 2025–26 / Tax Year 2026</div>
    </div>

    <p class="subnote">
      Uses <b>FBR Salary (Section 149) slab rates</b>. Supports partial months using day-based fractions.
      This is a <b>simplified estimator</b> (no exemptions/allowances/rebates/other income).
    </p>

    <!-- FORM -->
    <div class="card">
      <div class="inner">
        <div class="grid form">
          <div class="field">
            <label>Monthly Salary (PKR)</label>
            <input id="monthlySalary" type="number" placeholder="e.g., 250000" />
            <div class="hint">Enter monthly taxable salary (simplified).</div>
          </div>

          <div class="field">
            <label>Start Date (Joining within tax year)</label>
            <input id="startDate" type="date" />
            <div class="hint">If blank, assumes 2025-07-01</div>
          </div>

          <div class="field">
            <label>End Date (Leaving within tax year) — optional</label>
            <input id="endDate" type="date" />
            <div class="hint">If blank, assumes 2026-06-30</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="calcBtn">Calculate</button>
          <button class="btn secondary" id="copyBtn" disabled>Copy</button>
          <button class="btn secondary" id="csvBtn" disabled>Download CSV</button>
          <button class="btn secondary" id="pdfBtn" disabled>Download PDF</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          Allocation method: <b>Option A (tax per effective month × month fraction)</b> — purely tax perspective.
        </div>
      </div>
    </div>

    <!-- RESULTS + SLABS -->
    <div class="twoCol" style="margin-top:14px;">
      <div class="card">
        <div class="inner">
          <h3>Results</h3>

          <div class="kpis">
            <div class="kpi">
              <div class="label">Taxable Income (approx)</div>
              <div class="value" id="kpiIncome">—</div>
            </div>
            <div class="kpi">
              <div class="label">Estimated Total Tax</div>
              <div class="value" id="kpiTax">—</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="row">
              <div class="left">Period</div>
              <div class="right" id="rPeriod">—</div>
            </div>
            <div class="row">
              <div class="left">Effective Months (income basis)</div>
              <div class="right" id="rEffMonths">—</div>
            </div>
            <div class="row">
              <div class="left">Applied Slab</div>
              <div class="right" id="rSlab">—</div>
            </div>
            <div class="row">
              <div class="left">Slab Calculation</div>
              <div class="right" id="rSlabMath">—</div>
            </div>
          </div>

          <div class="footerNote" id="noteBlock">
            Notes: simplified estimator; exemptions/allowances/rebates not included.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="inner">
          <h3>Salary Slabs Used (TY 2026)</h3>
          <div class="tableWrap">
            <table id="slabTable">
              <thead>
                <tr>
                  <th>Range (PKR)</th>
                  <th class="rightAlign">Fixed Tax</th>
                  <th class="rightAlign">Marginal Rate</th>
                  <th>Formula</th>
                </tr>
              </thead>
              <tbody id="slabTbody"></tbody>
            </table>
          </div>
          <div class="footerNote">
            Highlight shows the slab applied to your taxable income.
          </div>
        </div>
      </div>
    </div>

    <!-- MONTHLY SCHEDULE -->
    <div class="card" style="margin-top:14px;">
      <div class="inner">
        <h3>Monthly Schedule</h3>
        <div class="footerNote" style="margin-top:-4px;">
          Income uses day-based fractions. Tax is allocated using Option A (fraction-based).
        </div>
        <div class="tableWrap" style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th class="rightAlign">Income Fraction</th>
                <th class="rightAlign">Income (approx)</th>
                <th class="rightAlign">Tax Allocated</th>
                <th class="rightAlign">Net Salary</th>
                <th class="rightAlign">Cumulative Tax</th>
              </tr>
            </thead>
            <tbody id="scheduleTbody">
              <tr><td colspan="6" style="color:#64748b;">Run a calculation to see the schedule.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="footerNote">
          This allocation is for transparency; actual payroll withholding can vary by employer policy.
        </div>
      </div>
    </div>

    <!-- DISCLAIMER (UI + required) -->
    <div class="card" style="margin-top:14px;">
      <div class="inner">
        <h3>Disclaimer</h3>
        <div class="footerNote" id="disclaimerText">
          This calculator is provided for general informational purposes only. While we have made every effort to ensure accuracy based on the applicable tax laws, users are strongly advised to consult the official FBR notifications and relevant legislation before making any financial or tax decisions. We do not assume any liability for errors, omissions, or reliance placed on the results generated by this tool.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Copied</div>

  <script>
    // =========================
    // Branding (PDF + Copy)
    // =========================
    const BRAND_URL = "https://pakistan-salary-tax-calculator-2026.daybook.com.pk";
    const LOGO_URL = "https://raw.githubusercontent.com/belawallatif5501/pakistan-salary-tax-calculator-2026/main/assets/Logo.jpg";

    const DISCLAIMER_TEXT =
      "Disclaimer: This calculator is provided for general informational purposes only. " +
      "While we have made every effort to ensure accuracy based on the applicable tax laws, " +
      "users are strongly advised to consult the official FBR notifications and relevant legislation " +
      "before making any financial or tax decisions. We do not assume any liability for errors, omissions, " +
      "or reliance placed on the results generated by this tool.";

    // -------------------------
    // State (for Copy/CSV/PDF)
    // -------------------------
    const state = {
      inputs: null,
      taxableIncome: 0,
      totalTax: 0,
      effectiveMonths: 0,
      appliedSlab: null,
      slabMathPlain: "",
      surchargeApplied: false,
      schedule: []
    };

    // -------------------------
    // Utils
    // -------------------------
    function parseLocalInputDate(value) {
      if (!value) return null;
      const parts = value.split("-");
      if (parts.length !== 3) return null;
      const y = Number(parts[0]);
      const m = Number(parts[1]);
      const d = Number(parts[2]);
      if (!y || !m || !d) return null;
      const dt = new Date(y, m - 1, d, 0, 0, 0, 0);
      return isNaN(dt.getTime()) ? null : dt;
    }

    function formatDateSafe(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function clampDate(d, min, max) {
      return new Date(Math.min(Math.max(d.getTime(), min.getTime()), max.getTime()));
    }

    function daysInMonth(year, monthIndex0) {
      return new Date(year, monthIndex0 + 1, 0).getDate();
    }

    function monthName(m0) {
      return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m0];
    }

    function formatPKR(n) {
      return (Math.round(n)).toLocaleString("en-PK");
    }

    function safePdfText(s) {
      return String(s || "")
        .replace(/[×✕]/g, "x")
        .replace(/[−–—]/g, "-")
        .replace(/\s+/g, " ")
        .trim();
    }

    function setText(id, text){ document.getElementById(id).textContent = text; }
    function setHTML(id, html){ document.getElementById(id).innerHTML = html; }

    function showToast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1200);
    }

    function enableExports(enabled){
      document.getElementById("copyBtn").disabled = !enabled;
      document.getElementById("csvBtn").disabled = !enabled;
      document.getElementById("pdfBtn").disabled = !enabled;
    }

    // -------------------------
    // Slabs (TY 2026)
    // -------------------------
    const SLABS_TY2026 = [
      { id: 1, label: "Up to 600,000",         lo: 0,        hi: 600000,   fixed: 0,      rate: 0.00, base: 0,
        formula: "0" },
      { id: 2, label: "600,001 – 1,200,000",   lo: 600000,   hi: 1200000,  fixed: 0,      rate: 0.01, base: 600000,
        formula: "1% of (Income - 600,000)" },
      { id: 3, label: "1,200,001 – 2,200,000", lo: 1200000,  hi: 2200000,  fixed: 6000,   rate: 0.11, base: 1200000,
        formula: "6,000 + 11% of (Income - 1,200,000)" },
      { id: 4, label: "2,200,001 – 3,200,000", lo: 2200000,  hi: 3200000,  fixed: 116000, rate: 0.23, base: 2200000,
        formula: "116,000 + 23% of (Income - 2,200,000)" },
      { id: 5, label: "3,200,001 – 4,100,000", lo: 3200000,  hi: 4100000,  fixed: 346000, rate: 0.30, base: 3200000,
        formula: "346,000 + 30% of (Income - 3,200,000)" },
      { id: 6, label: "Above 4,100,000",       lo: 4100000,  hi: Infinity, fixed: 616000, rate: 0.35, base: 4100000,
        formula: "616,000 + 35% of (Income - 4,100,000)" },
    ];

    function getAppliedSlab(income) {
      if (income <= 600000) return SLABS_TY2026[0];
      for (const s of SLABS_TY2026) {
        if (income > s.lo && income <= s.hi) return s;
        if (s.hi === Infinity && income > s.lo) return s;
      }
      return SLABS_TY2026[0];
    }

    function salaryTaxTY2026(income) {
      const slab = getAppliedSlab(income);
      let tax = 0;

      if (slab.id === 1) tax = 0;
      else tax = slab.fixed + (income - slab.base) * slab.rate;

      const surchargeApplied = income > 10000000;
      if (surchargeApplied) tax = tax + (tax * 0.09);

      return { tax, slab, surchargeApplied };
    }

    function renderSlabTable(appliedSlabId) {
      const tbody = document.getElementById("slabTbody");
      tbody.innerHTML = "";

      for (const s of SLABS_TY2026) {
        const tr = document.createElement("tr");
        if (s.id === appliedSlabId) tr.className = "trApplied";

        const range = s.hi === Infinity
          ? `> ${formatPKR(s.lo)}`
          : `${formatPKR(s.lo + 1)} – ${formatPKR(s.hi)}`;

        tr.innerHTML = `
          <td>${s.label}<div style="color:#64748b;font-size:12px;margin-top:4px;">(${range})</div></td>
          <td class="rightAlign">PKR ${formatPKR(s.fixed)}</td>
          <td class="rightAlign">${Math.round(s.rate*100)}%</td>
          <td>${s.formula}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // -------------------------
    // Month fractions (day-based)
    // -------------------------
    function computeMonthlyFractions(startDate, endDate) {
      const rows = [];
      let cur = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
      const endMonthStart = new Date(endDate.getFullYear(), endDate.getMonth(), 1);

      let total = 0;

      while (cur.getTime() <= endMonthStart.getTime()) {
        const y = cur.getFullYear();
        const m = cur.getMonth();
        const dim = daysInMonth(y, m);

        const monthStart = new Date(y, m, 1);
        const monthEnd = new Date(y, m, dim);

        const activeStart = new Date(Math.max(monthStart.getTime(), startDate.getTime()));
        const activeEnd = new Date(Math.min(monthEnd.getTime(), endDate.getTime()));

        let fraction = 0;
        if (activeStart.getTime() <= activeEnd.getTime()) {
          const daysWorked = Math.floor((activeEnd - activeStart) / (1000*60*60*24)) + 1;
          fraction = daysWorked / dim;
        }

        total += fraction;
        rows.push({ y, m, dim, fraction });

        cur = new Date(y, m + 1, 1);
      }

      return { total, rows };
    }

    // -------------------------
    // Copy / CSV / PDF
    // -------------------------
    function buildSummaryText(){
      const i = state.inputs;
      const slab = state.appliedSlab;

      const lines = [];
      lines.push("Pakistan Salary Tax Calculator (FY 2025–26 / TY 2026)");
      lines.push(`Monthly Salary: PKR ${formatPKR(i.salary)}`);
      lines.push(`Period: ${i.periodStart} to ${i.periodEnd}`);
      lines.push(`Effective Months: ${state.effectiveMonths.toFixed(4)}`);
      lines.push(`Taxable Income (approx): PKR ${formatPKR(state.taxableIncome)}`);
      lines.push(`Estimated Total Tax: PKR ${formatPKR(state.totalTax)}`);
      lines.push(`Applied Slab: ${slab ? slab.label : "-"}`);
      lines.push(`Slab Calculation: ${state.slabMathPlain}`);
      lines.push(`Surcharge Applied: ${state.surchargeApplied ? "Yes (9%)" : "No"}`);
      lines.push("");
      lines.push("Monthly Schedule (Month | Fraction | Income | Tax Allocated | Net Salary | Cumulative)");
      for (const r of state.schedule){
        lines.push(`${r.label} | ${r.fraction.toFixed(4)} | ${formatPKR(r.income)} | ${formatPKR(r.tax)} | ${formatPKR(r.net)} | ${formatPKR(r.cumulative)}`);
      }
      lines.push("");
      lines.push(DISCLAIMER_TEXT);
      lines.push(BRAND_URL);
      return lines.join("\n");
    }

    function downloadCSV(){
      const i = state.inputs;
      const slab = state.appliedSlab;

      const headerRows = [
        ["Report","Pakistan Salary Tax Calculator (FY 2025–26 / TY 2026)"],
        ["Monthly Salary (PKR)", i.salary],
        ["Period Start", i.periodStart],
        ["Period End", i.periodEnd],
        ["Effective Months", state.effectiveMonths.toFixed(6)],
        ["Taxable Income (approx)", Math.round(state.taxableIncome)],
        ["Estimated Total Tax", Math.round(state.totalTax)],
        ["Applied Slab", slab ? slab.label : ""],
        ["Slab Calculation", state.slabMathPlain],
        ["Surcharge Applied", state.surchargeApplied ? "Yes (9%)" : "No"],
        ["Disclaimer", DISCLAIMER_TEXT],
        ["Source", BRAND_URL],
        [],
        ["Month","Income Fraction","Income (approx)","Tax Allocated","Net Salary","Cumulative Tax"]
      ];

      const scheduleRows = state.schedule.map(r => ([
        r.label,
        r.fraction.toFixed(6),
        Math.round(r.income),
        Math.round(r.tax),
        Math.round(r.net),
        Math.round(r.cumulative)
      ]));

      const all = headerRows.concat(scheduleRows);

      const csv = all.map(row => row.map(cell => {
        const s = (cell ?? "").toString();
        const escaped = s.replace(/"/g,'""');
        return `"${escaped}"`;
      }).join(",")).join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `salary-tax-ty2026_${i.periodStart}_to_${i.periodEnd}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function loadImageFromUrl(url) {
      const res = await fetch(url, { mode: "cors" });
      if (!res.ok) throw new Error("Logo fetch failed");

      const blob = await res.blob();
      const dataUrl = await new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(blob);
      });

      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = dataUrl;
      });

      return { dataUrl, width: img.naturalWidth || img.width, height: img.naturalHeight || img.height };
    }

    function addFooter(doc) {
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      doc.setFont("helvetica", "normal");
      doc.setFontSize(9);
      doc.setTextColor(0, 102, 204);

      const text = BRAND_URL;
      const textWidth = doc.getTextWidth(text);
      const x = pageWidth - 40 - textWidth;
      const y = pageHeight - 24;

      doc.textWithLink(text, x, y, { url: text });
      doc.setTextColor(0,0,0);
    }

    async function downloadPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"a4" });

      const i = state.inputs;
      const slab = state.appliedSlab;

      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      const margin = 40;
      let y = 52;

      // Header title (left)
      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.text("Pakistan Salary Tax Calculator (FY 2025–26 / TY 2026)", margin, y);

      // Logo (top-right) — keep aspect ratio
      if (LOGO_URL && LOGO_URL.trim().length > 0) {
        try{
          const { dataUrl, width, height } = await loadImageFromUrl(LOGO_URL.trim());
          const maxW = 90;
          const maxH = 28;
          const scale = Math.min(maxW / width, maxH / height);
          const w = Math.round(width * scale);
          const h = Math.round(height * scale);

          const x = pageWidth - margin - w;
          const yLogo = 26;

          const fmt = dataUrl.startsWith("data:image/jpeg") ? "JPEG" : "PNG";
          doc.addImage(dataUrl, fmt, x, yLogo, w, h);
        } catch(e){ /* skip logo */ }
      }

      y += 18;

      // subtitle
      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.setTextColor(60,60,60);
      doc.text("Simplified estimator (no exemptions/allowances/rebates/other income).", margin, y);
      y += 18;

      doc.setTextColor(0,0,0);
      doc.setFont("helvetica","bold");
      doc.text("Summary", margin, y);
      y += 12;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);

      const summaryLines = [
        `Monthly Salary: PKR ${formatPKR(i.salary)}`,
        `Period: ${i.periodStart} to ${i.periodEnd}`,
        `Effective Months: ${state.effectiveMonths.toFixed(4)}`,
        `Taxable Income (approx): PKR ${formatPKR(state.taxableIncome)}`,
        `Estimated Total Tax: PKR ${formatPKR(state.totalTax)}`,
        `Applied Slab: ${slab ? slab.label : "-"}`,
        `Surcharge Applied: ${state.surchargeApplied ? "Yes (9%)" : "No"}`,
      ];

      for (const line of summaryLines){
        if (y > pageHeight - 70) { addFooter(doc); doc.addPage(); y = 52; }
        doc.text(line, margin, y);
        y += 14;
      }

      y += 6;
      doc.setFont("helvetica","bold");
      doc.text("Slab Calculation", margin, y);
      y += 12;

      doc.setFont("helvetica","normal");

      const slabText = safePdfText(state.slabMathPlain || "-");
      const slabLines = doc.splitTextToSize(slabText, pageWidth - (margin * 2));
      const slabHeight = slabLines.length * 12;

      if (y + slabHeight > pageHeight - 70) {
        addFooter(doc);
        doc.addPage();
        y = 52;
      }

      doc.text(slabLines, margin, y);
      y += slabHeight + 10;

      doc.setFont("helvetica","bold");
      doc.text("Monthly Schedule (first 12 rows)", margin, y);
      y += 12;

      doc.setFont("helvetica","normal");
      doc.setTextColor(60,60,60);
      doc.text("Full schedule is available in CSV download.", margin, y);
      y += 14;
      doc.setTextColor(0,0,0);

      const col = [margin, margin+120, margin+220, margin+340, margin+450, margin+560];
      doc.setFont("helvetica","bold");
      doc.text("Month", col[0], y);
      doc.text("Fraction", col[1], y);
      doc.text("Income", col[2], y);
      doc.text("Tax", col[3], y);
      doc.text("Net", col[4], y);
      doc.text("Cum Tax", col[5], y);
      y += 10;

      doc.setLineWidth(0.6);
      doc.setDrawColor(220);
      doc.line(margin, y, pageWidth - margin, y);
      y += 12;

      doc.setFont("helvetica","normal");

      const rows = state.schedule.slice(0, 12);
      for (const r of rows){
        if (y > pageHeight - 60) {
          addFooter(doc);
          doc.addPage();
          y = 52;
        }
        doc.text(r.label, col[0], y);
        doc.text(r.fraction.toFixed(4), col[1], y);
        doc.text(formatPKR(r.income), col[2], y);
        doc.text(formatPKR(r.tax), col[3], y);
        doc.text(formatPKR(r.net), col[4], y);
        doc.text(formatPKR(r.cumulative), col[5], y);
        y += 14;
      }

      // Disclaimer (PDF)
      doc.setFont("helvetica","normal");
      doc.setFontSize(9);
      doc.setTextColor(90);

      const dLines = doc.splitTextToSize(DISCLAIMER_TEXT, pageWidth - (margin * 2));
      const dHeight = dLines.length * 12;

      if (y + dHeight > pageHeight - 60) {
        addFooter(doc);
        doc.addPage();
        y = 52;
      }

      doc.text(dLines, margin, y);
      y += dHeight + 6;

      doc.setTextColor(0);

      // Footer (clickable)
      addFooter(doc);

      doc.save(`salary-tax-ty2026_${i.periodStart}_to_${i.periodEnd}.pdf`);
    }

    // -------------------------
    // Calculate
    // -------------------------
    document.getElementById("calcBtn").addEventListener("click", () => {
      const salary = Number(document.getElementById("monthlySalary").value);
      if (!salary || salary <= 0) {
        alert("Please enter a valid monthly salary.");
        return;
      }

      // FY 2025-26: 01-Jul-2025 to 30-Jun-2026
      const fyStart = new Date(2025, 6, 1);
      const fyEnd = new Date(2026, 5, 30);

      const rawStart = parseLocalInputDate(document.getElementById("startDate").value) || fyStart;
      const rawEnd = parseLocalInputDate(document.getElementById("endDate").value) || fyEnd;

      const s0 = rawStart.getTime() <= rawEnd.getTime() ? rawStart : rawEnd;
      const e0 = rawStart.getTime() <= rawEnd.getTime() ? rawEnd : rawStart;

      const start = clampDate(s0, fyStart, fyEnd);
      const end = clampDate(e0, fyStart, fyEnd);

      const { total: effectiveMonths, rows } = computeMonthlyFractions(start, end);
      const taxableIncome = salary * effectiveMonths;

      const taxResult = salaryTaxTY2026(taxableIncome);
      const totalTax = taxResult.tax;
      const appliedSlab = taxResult.slab;

      let slabMathPlain = "";
      let slabMathHTML = "";

      if (appliedSlab.id === 1) {
        slabMathPlain = `No tax (<= PKR 600,000).`;
        slabMathHTML = slabMathPlain;
      } else {
        const marginalBase = taxableIncome - appliedSlab.base;
        const marginalTax = marginalBase * appliedSlab.rate;
        const preSurcharge = appliedSlab.fixed + marginalTax;

        slabMathPlain =
          `PKR ${formatPKR(appliedSlab.fixed)} + ${Math.round(appliedSlab.rate*100)}% x (PKR ${formatPKR(taxableIncome)} - PKR ${formatPKR(appliedSlab.base)}) = PKR ${formatPKR(preSurcharge)}` +
          (taxResult.surchargeApplied ? `, then +9% surcharge` : ``);

        slabMathHTML =
          `PKR ${formatPKR(appliedSlab.fixed)} + ${Math.round(appliedSlab.rate*100)}% × (PKR ${formatPKR(taxableIncome)} − PKR ${formatPKR(appliedSlab.base)}) = PKR ${formatPKR(preSurcharge)}` +
          (taxResult.surchargeApplied ? ` <span class="pill warn" style="margin-left:8px;">+9% Surcharge</span>` : ``);
      }

      const taxPerEffectiveMonth = effectiveMonths > 0 ? (totalTax / effectiveMonths) : 0;

      let cumulativeTax = 0;
      const schedule = rows.map(r => {
        const income = salary * r.fraction;
        const taxThisMonth = taxPerEffectiveMonth * r.fraction;
        const net = income - taxThisMonth;
        cumulativeTax += taxThisMonth;

        return {
          label: `${monthName(r.m)}-${String(r.y).slice(-2)}`,
          fraction: r.fraction,
          income,
          tax: taxThisMonth,
          net,
          cumulative: cumulativeTax
        };
      });

      setText("kpiIncome", `PKR ${formatPKR(taxableIncome)}`);
      setText("kpiTax", `PKR ${formatPKR(totalTax)}`);

      setText("rPeriod", `${formatDateSafe(start)} to ${formatDateSafe(end)}`);
      setText("rEffMonths", effectiveMonths.toFixed(4));
      setHTML("rSlab", appliedSlab.label);
      setHTML("rSlabMath", slabMathHTML);

      const surchargePill = taxResult.surchargeApplied
        ? `<span class="pill warn">9% Surcharge Applied</span>`
        : `<span class="pill good">No Surcharge</span>`;

      setHTML("noteBlock",
        `Notes: simplified estimator; exemptions/allowances/rebates not included. ${surchargePill}`
      );

      renderSlabTable(appliedSlab.id);

      const tbody = document.getElementById("scheduleTbody");
      tbody.innerHTML = "";
      for (const s of schedule) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.label}</td>
          <td class="rightAlign">${s.fraction.toFixed(4)}</td>
          <td class="rightAlign">PKR ${formatPKR(s.income)}</td>
          <td class="rightAlign">PKR ${formatPKR(s.tax)}</td>
          <td class="rightAlign">PKR ${formatPKR(s.net)}</td>
          <td class="rightAlign">PKR ${formatPKR(s.cumulative)}</td>
        `;
        tbody.appendChild(tr);
      }

      state.inputs = { salary, periodStart: formatDateSafe(start), periodEnd: formatDateSafe(end) };
      state.taxableIncome = taxableIncome;
      state.totalTax = totalTax;
      state.effectiveMonths = effectiveMonths;
      state.appliedSlab = appliedSlab;
      state.slabMathPlain = slabMathPlain;
      state.surchargeApplied = taxResult.surchargeApplied;
      state.schedule = schedule;

      enableExports(true);
    });

    document.getElementById("copyBtn").addEventListener("click", async () => {
      try{
        const text = buildSummaryText();
        await navigator.clipboard.writeText(text);
        showToast("Copied ✅");
      }catch(e){
        alert("Copy failed. Your browser may block clipboard access.");
      }
    });

    document.getElementById("csvBtn").addEventListener("click", () => downloadCSV());

    document.getElementById("pdfBtn").addEventListener("click", async () => {
      try{ await downloadPDF(); }
      catch(e){ alert("PDF failed. If logo blocks loading, keep LOGO_URL as GitHub RAW link."); }
    });

    renderSlabTable(-1);
    enableExports(false);
  </script>
</body>
</html>
